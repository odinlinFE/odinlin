import { join, resolve } from 'path'
import { readdir, writeFile } from 'fs/promises'

// 处理输入输出文件
const inputDir = resolve(__dirname, '../../', 'packages/ag-grid-react/src/locales')
const createOutputFile = (filename: string) => resolve(__dirname, '../../', 'packages/ag-grid-react/src/locales', filename)

/**
 * @title 为每个国家的语言文件添加前缀
 */
function addFiledPrefix(prefix: string, temp: any): any {
  const result: any = {}
  for (const key in temp) {
    if (Object.prototype.hasOwnProperty.call(temp, key)) {
      result[`${prefix}.${key}`] = temp[key]
    }
  }
  return result
}

// IIFE fs文件操作
(async () => {
  try {
    const files = await readdir(inputDir)

    const locales = await files.reduce(async (prev, filename) => {
      if (filename === 'index.ts') { return prev }

      // 读取各个国家的语言文件
      const filePath = join(inputDir, filename)
      const content = await import(filePath)

      // 加上前缀并合并
      return Object.assign(
        prev,
        addFiledPrefix(filename.replace('.ts', ''), content.default),
      )
    }, {})

    // 保存合并后的文件
    await writeFile(
      createOutputFile('index.ts'),
      `// This file is generated by Odinlin automatically\n// DO NOT CHANGE IT MANUALLY!\nexport default ${JSON.stringify(locales, null, 2)}`,
    )

    console.log('generated successfully!')
  }
  catch (error) {
    console.log('generated failed?')
  }
})()
